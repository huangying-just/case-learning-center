# Case Learning Center 更新日志

## [1.1.0] - 2024-06-12

### ✨ 新功能

#### 🚀 多附件管理系统
- **多文件上传**: 支持每个案例上传最多10个附件文件
- **向后兼容**: 完全兼容原有单附件格式，无缝升级
- **文件类型支持**: 扩展支持文档(PDF、Word、PPT、TXT)、图片(JPG、PNG、GIF、SVG、WebP)、Markdown(MD)、网页(HTML)等格式
- **图片预览**: 图片文件支持在案例详情页在线预览
- **文件信息显示**: 显示文件大小、类型等详细信息
- **单独管理**: 支持为已有案例单独添加或删除附件

#### 🏷️ 智能标签管理
- **双重添加方式**: 支持回车键和点击图标两种方式添加标签
- **重复检测**: 自动检测并阻止重复标签添加，显示友好提示
- **用户反馈**: 添加标签成功时显示确认消息
- **输入优化**: 自动去除首尾空格，防止空白标签

### 🔧 Bug修复

#### 附件下载问题
- **端口错误**: 修复下载链接指向错误端口(3000改为3001)的问题
- **路径异常**: 解决attachment_path为undefined导致的下载失败
- **下载方式**: 改用JavaScript创建下载链接，提高兼容性
- **条件判断**: 只有同时存在文件名和路径时才显示下载按钮

#### 表单交互优化
- **回车键冲突**: 修复在标签输入框按回车键时意外触发表单提交的问题
- **事件处理**: 在所有标签输入框添加`preventDefault()`阻止默认行为
- **焦点管理**: 优化输入框焦点处理，支持连续添加标签

### 🗃️ 数据库优化

#### 新增数据表
```sql
-- 新增案例附件表
CREATE TABLE case_attachments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    case_id INTEGER NOT NULL,
    filename VARCHAR(255) NOT NULL,
    original_name VARCHAR(255) NOT NULL,
    file_path TEXT NOT NULL,
    file_size INTEGER,
    mime_type VARCHAR(100),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (case_id) REFERENCES cases(id) ON DELETE CASCADE
);
```

#### 数据迁移
- **迁移脚本**: 创建`updateMultipleAttachments.js`脚本
- **数据保护**: 自动将现有单附件数据迁移到新表结构
- **兼容性**: 保留原有字段确保向后兼容

### 🔒 安全增强

#### 文件验证
- **类型白名单**: 严格的文件类型验证，支持扩展名和MIME类型双重检查
- **大小限制**: 单文件最大20MB限制
- **数量限制**: 最多上传10个附件文件
- **恶意文件防护**: 阻止潜在恶意文件上传

### 🎨 用户界面优化

#### 附件显示区域
- **信息展示**: 显示文件名、大小、类型等完整信息
- **状态标识**: 清晰区分新老附件格式
- **预览功能**: 图片文件支持点击预览
- **操作按钮**: 统一的下载按钮样式和交互

#### 标签输入体验
- **视觉提升**: "+" 图标增加蓝色主题色和鼠标悬停效果
- **操作反馈**: 即时的成功/警告消息提示
- **交互优化**: 支持键盘和鼠标两种操作方式

### 🔧 技术改进

#### API增强
- **新增端点**: 
  - `POST /api/cases/:id/attachments` - 添加附件
  - `DELETE /api/cases/:id/attachments/:attachmentId` - 删除附件
- **响应优化**: 返回完整附件元数据信息
- **错误处理**: 改进API错误处理和用户提示

#### 后端优化
- **Multer配置**: 从单文件改为多文件上传支持
- **数据库操作**: 优化查询逻辑，支持新老数据混合查询
- **级联删除**: 实现附件的级联删除功能

### 📋 破坏性变更
- 无破坏性变更，完全向后兼容v1.0.0

### ⬆️ 升级指南

#### 自动升级
1. 拉取最新代码
2. 重启应用即可自动完成数据库升级

#### 手动升级
如果需要手动运行数据库迁移：
```bash
cd backend
node scripts/updateMultipleAttachments.js
```

### 🙏 致谢
感谢所有提出宝贵意见和Bug报告的用户，您的反馈帮助我们不断改进产品质量。

---

## [1.0.0] - 2024-06-11

### 🎉 初始版本
- 完整的前后端分离架构
- JWT认证和角色权限系统
- 案例CRUD功能
- 文件上传和管理
- 响应式Web界面
- 完整的API文档
- 演示数据和部署指南 